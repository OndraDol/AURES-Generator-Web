<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8">
<title>AURES Generátor LP</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" href="data:,">

<style>
 body{font-family:Arial,Helvetica,sans-serif;background:#f5f5f5;margin:0;padding:20px;color:#222}
 h1{font-size:26px;margin:0 0 20px}
 .row{display:flex;gap:12px;margin-bottom:10px;align-items:center}
 label{width:140px;font-weight:600}
 input,select{flex:1;min-width:200px;padding:6px;border:1px solid #ccc;border-radius:4px}
 button{padding:8px 16px;background:#007acc;color:#fff;border:none;border-radius:4px;cursor:pointer}
 button:disabled{background:#ccc;cursor:not-allowed}
 #drop{border:2px dashed #888;padding:20px;text-align:center;margin:20px 0;border-radius:6px;background:#fff}
 #drop.drag{border-color:#007acc;background:#eef6ff}
 #status{margin-top:12px;font-size:14px;min-height:18px}
</style>

<!-- knihovny -->
<script defer src="https://unpkg.com/docxtemplater@3.29.0/build/docxtemplater.pizzip.min.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/file-saver/2.0.5/FileSaver.min.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous"></script>
</head>
<body>
<h1>AURES Generátor LP</h1>

<div id="drop">
  Přetáhni PDF nebo klikni
  <input type="file" id="file" accept="application/pdf" hidden>
</div>

<div class="row"><label>Jméno</label><input id="jmeno"></div>
<div class="row"><label>Datum narození</label><input id="narozeni"></div>
<div class="row"><label>Adresa</label><input id="adresa"></div>
<div class="row"><label>PSČ</label><input id="psc"></div>

<h3>Faktory (1 – 6)</h3>
<div id="factors"></div>

<div class="row"><label>Pobočka</label>
  <select id="pobocka">
    <option>Praha</option><option>Brno</option><option>Ostrava</option>
  </select>
</div>
<div class="row"><label>Pozice</label><input id="pozice" value="Prodejce"></div>

<!-- DOPLNĚNÝ číselník -->
<div class="row"><label>Popis pozice</label>
  <select id="popis">
    <option>Řidič referent</option>
    <option>Práce s PC</option>
    <option>Práce ve skladu</option>
  </select>
</div>

<div class="row"><label>Konzultant</label>
  <select id="konzultant">
    <option>Jan Novák</option><option>Petra Dvořáková</option>
  </select>
</div>

<div class="row"><button id="gen" disabled>Generovat DOCX</button></div>
<p id="status"></p>

<script>
/* ---------- pdf.js worker ---------- */
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

/* ---------- elementy & helper ---------- */
const $ = id => document.getElementById(id);
const setStatus = (t,err=false)=>{ $('status').textContent=t; $('status').style.color=err?'#b00':'#006400'; };

/* ---------- faktory ---------- */
for(let i=1;i<=6;i++){
  const row=document.createElement('div');row.className='row';
  row.innerHTML=`<label>Faktor ${i}</label><select id="faktor_${i}">
    <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
  </select>`;
  $('factors').append(row);
}

/* ---------- drag & click ---------- */
const drop=$('drop'), fileInput=$('file');
drop.addEventListener('click',()=>fileInput.click());
['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{
  e.preventDefault(); drop.classList.add('drag');}));
['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,()=>drop.classList.remove('drag')));
drop.addEventListener('drop',e=>{
  e.preventDefault(); if(e.dataTransfer.files[0]) loadPDF(e.dataTransfer.files[0]);});
fileInput.addEventListener('change',e=>{
  if(e.target.files[0]) loadPDF(e.target.files[0]);
});

/* ---------- PDF → formulář ---------- */
async function loadPDF(file){
  if(file.type!=='application/pdf'){setStatus('Není PDF',true);return;}
  setStatus('Čtu PDF…'); $('gen').disabled=true;
  try{
    const pdf=await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
    const page=await pdf.getPage(1);
    const ann=await page.getAnnotations({intent:'display'});   // ← pole OK
    const val=n=>ann.find(a=>a.fieldName?.trim()===n)?.fieldValue||'';

    $('jmeno').value=val('jmeno');
    $('narozeni').value=(val('narozeni')||'').split('/')[0];
    $('adresa').value=[val('trvale-bydliste-ulice'),val('trvale-bydliste-mesto')]
                  .filter(Boolean).join(', ');
    $('psc').value=val('trvale-bydliste-psc');
    setStatus('PDF načteno – můžeš generovat'); $('gen').disabled=false;
  }catch(e){console.error(e); setStatus('Chyba PDF',true);}
}

/* ---------- DOCX ---------- */
$('gen').addEventListener('click',async()=>{
  setStatus('Načítám šablonu…'); $('gen').disabled=true;
  try{
    const res=await fetch('LP_template.docx');
    if(!res.ok) throw new Error('Chybí LP_template.docx');
    const zip=new PizZip(await res.arrayBuffer());

    const Doc=window.docxtemplater;               // balík exportuje takto
    if(typeof Doc!=='function') throw new Error('Docxtemplater se nenačetl');

    const doc=new Doc(zip,{paragraphLoop:true,linebreaks:true,nullGetter:()=>''});
    const ctx={
      jmeno:$('jmeno').value,
      narozeni:$('narozeni').value,
      adresa:$('adresa').value,
      psc:$('psc').value,
      pobocka:$('pobocka').value,
      pozice:$('pozice').value,
      popis:$('popis').value,
      konzultant:$('konzultant').value,
      datum:new Date().toLocaleDateString('cs-CZ')
    };
    for(let i=1;i<=6;i++) ctx[`faktor_${i}`]=$(`faktor_${i}`).value;

    doc.render(ctx);
    saveAs(doc.getZip().generate({type:'blob'}),
           `LP_${(ctx.jmeno||'soubor').replace(/\s+/g,'_')}.docx`);
    setStatus('DOCX stažen');
  }catch(e){console.error(e); setStatus(e.message,true);}
  $('gen').disabled=false;
});
</script>
</body>
</html>
