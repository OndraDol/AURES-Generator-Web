<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8">
<title>AURES Generátor LP</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f5f5f5;margin:0;padding:20px;color:#222}
  h1{font-size:26px;margin-top:0}
  .row{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:12px}
  label{width:140px;font-weight:600}
  input,select{flex:1;padding:6px}
  select{min-width:220px}
  button{padding:10px 18px;cursor:pointer;background:#007ACC;color:#fff;border:none;border-radius:4px}
  #dropZone{border:2px dashed #888;padding:20px;text-align:center;margin-bottom:14px;background:#fff;border-radius:6px}
  #dropZone.drag{border-color:#000}
  #status{margin-top:14px;font-size:14px}
</style>
<!-- CDN knihovny -->
<script src="https://unpkg.com/pizzip@3.1.1/dist/pizzip.min.js"></script>
<script src="https://unpkg.com/docxtemplater@3.41.2/build/docxtemplater.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
</head>
<body>
  <h1>AURES Generátor LP</h1>
  <div id="dropZone">Přetáhni osobní PDF sem nebo <input type="file" id="fileInput" accept="application/pdf"/></div>
  <div class="row"><label>Jméno</label><input id="jmeno"/></div>
  <div class="row"><label>Datum narození</label><input id="narozeni"/></div>
  <div class="row"><label>Adresa</label><input id="adresa"/></div>
  <div class="row"><label>PSČ</label><input id="psc"/></div>
  <h3>Faktory a Kategorie (1–6)</h3>
  <div id="factors"></div>
  <div class="row"><label>Pobočka</label><select id="pobocka"></select></div>
  <div class="row"><label>Pozice</label><input id="pozice"/></div>
  <div class="row"><label>Konzultant</label><select id="konzultant"></select><input type="checkbox" id="remember"><span>Zapamatovat</span></div>
  <div class="row"><label>Pozice popis</label><select id="pozice_popis"></select></div>
  <div class="row"><button id="genDocx">Generovat DOCX</button></div>
  <p id="status"></p>

  <script>
  // Constants
  const FACTOR_OPTIONS=["Zátěž chladem","Fyzická zátěž","Pracovní poloha","Hluk","Vibrace","Prach","Chemické látky a směsi","------------------","Biologické činitele","Činnosti epidemiologicky závažné","Elektrotechnik dle vyhl č.50 / 1978 Sb.","Neionizující záření","Obsluha tlakových nádob a zařízení vys. napětí","Obsluha transport. a vysokozdvižných vozíků","Obsluha transport. vytáhů a jeřábů a vázaní břemen","Práce v noci","Práce ve výškách a nad volnou hloubkou","Psychická zátěž","Řidič do 7,5 tuny","Řidič nad 7,5 tuny","Vyšetření v základním rozsahu","Zátež teplem","Zraková zátěž"];
  const CATEGORY_OPTIONS=["","Kat. 1","Kat. 2","Kat. 3","Kat. 4"];
  const BRANCH_LIST=["Brno","Chomutov","České Budějovice","Čestlice","Hradec Králové","Jihlava","Kladno","Kolín","Liberec","Mladá Boleslav","Olomouc","Opava","Ostrava","Pardubice","Plzeň","Praha","Sokolov","Tábor","Teplice","Ústí nad Labem","Valašské Meziříčí","Zlín","Znojmo"];
  const CONSULTANT_LIST=["Anna Brůčková","Anna Kučerová","Alžběta Čermáková","Blanka Poliaková","Jan Jarma","Kamila Hušková","Karolína Kulvaitová","Miroslava Válková","Ondřej Dolejš"];
  const POSITION_DESCRIPTIONS={
    "Call Centrum":"Činnost s klienty po telefonu, práce na PC, administrativa. Dvousměnný provoz.",
    "Manažer/Zástupce manažera":"Vedení týmu, administrativa, řízení služebního auta.",
    "Prodejce":"Jednání s klienty, PC, řízení auta, částečně venku.",
    "Nákupčí / Testovací technik":"Administrativa + testování vozů, řízení auta.",
    "Výpomoc při přípravě vozů k prodeji":"Mytí a čištění vozů venku. Bez řízení auta.",
    "Mechanik":"Údržba a opravy vozidel, chemikálie H314. Řízení auta.",
    "Uklízečka":"Úklid areálu.",
    "Stock kontrolor":"Kontrola vozového parku, převoz vozů v areálu.",
    "Řidič do 7,5t/ Kurýr":"Přeprava zákazníků a vozidel.",
    "Řidič nad 7,5t":"Přeprava vozů mezi pobočkami, nakládka/vykládka vozů."
  };

  // Helpers
  function fillSelect(el, arr){ el.innerHTML=''; arr.forEach(v=>{ const o=document.createElement('option'); o.value=o.textContent=v; el.appendChild(o); }); }
  function addFactors(){ const wrap=document.getElementById('factors'); for(let i=0;i<6;i++){ const row=document.createElement('div'); row.className='row'; const f=document.createElement('select'); fillSelect(f,FACTOR_OPTIONS); const k=document.createElement('select'); fillSelect(k,CATEGORY_OPTIONS); if(i===0){f.value='Vyšetření v základním rozsahu';k.value='Kat. 1';} f.dataset.key=`faktor${i+1}`; k.dataset.key=`kategorie${i+1}`; row.appendChild(f); row.appendChild(k); wrap.appendChild(row); } }
  function status(msg, err=false){ const s=document.getElementById('status'); s.textContent=msg; s.style.color=err?'#b00':'#006400'; }

  // Init UI
  function init(){
    fillSelect(document.getElementById('pobocka'), BRANCH_LIST);
    fillSelect(document.getElementById('konzultant'), CONSULTANT_LIST);
    fillSelect(document.getElementById('pozice_popis'), Object.keys(POSITION_DESCRIPTIONS));
    addFactors();
    const key='konzultant', sel=document.getElementById('konzultant');
    if(localStorage.getItem(key)){ sel.value=localStorage.getItem(key); document.getElementById('remember').checked=true; }
    sel.addEventListener('change', ()=>{ if(document.getElementById('remember').checked) localStorage.setItem(key, sel.value); });
    document.getElementById('remember').addEventListener('change', e=>{ if(e.target.checked) localStorage.setItem(key, sel.value); else localStorage.removeItem(key); });
  }
  document.addEventListener('DOMContentLoaded', init);

  // PDF parsing
  async function loadPDF(file){
    status('Načítám PDF…');
    const bytes=await file.arrayBuffer(); let ok=false;
    try{
      const pdfDoc=await PDFLib.PDFDocument.load(bytes);
      const form=pdfDoc.getForm();
      const getField=name=>{ try{return form.getTextField(name).getText()||'';} catch{return ''; } };
      const nm=getField('jmeno');
      if(nm){ ok=true;
        document.getElementById('jmeno').value=nm;
        document.getElementById('narozeni').value=getField('narozeni').split('/')[0].trim();
        document.getElementById('adresa').value=[getField('trvale-bydliste-ulice'), getField('trvale-bydliste-mesto')].filter(Boolean).join(', ');
        document.getElementById('psc').value=getField('trvale-bydliste-psc');
      }
    } catch(e){ console.warn(e); }
    if(!ok){
      const pdf=await pdfjsLib.getDocument({data:new Uint8Array(bytes)}).promise;
      let text='';
      for(let i=1;i<=pdf.numPages;i++){
        const page=await pdf.getPage(i); const content=await page.getTextContent();
        text+=content.items.map(it=>it.str).join('\n')+'\n';
      }
      const grab=k=>{ const m=text.match(new RegExp(k+'\\s*[:\\-]\\s*([^\\n]+)','i')); return m?m[1].trim():''; };
      document.getElementById('jmeno').value=grab('jmeno');
      let nar=grab('narozeni'); if(nar.includes('/')) nar=nar.split('/')[0];
      document.getElementById('narozeni').value=nar;
      document.getElementById('adresa').value=[grab('trvale-bydliste-ulice'), grab('trvale-bydliste-mesto')].filter(Boolean).join(', ');
      document.getElementById('psc').value=grab('trvale-bydliste-psc');
    }
    status('PDF načteno');
  }
  document.getElementById('dropZone').addEventListener('dragover',e=>{e.preventDefault(); e.currentTarget.classList.add('drag');});
  document.getElementById('dropZone').addEventListener('dragleave',e=>{ e.currentTarget.classList.remove('drag'); });
  document.getElementById('dropZone').addEventListener('drop',e=>{ e.preventDefault(); e.currentTarget.classList.remove('drag'); if(e.dataTransfer.files[0]) loadPDF(e.dataTransfer.files[0]); });
  document.getElementById('fileInput').addEventListener('change',e=>{ if(e.target.files[0]) loadPDF(e.target.files[0]); });

  // Load template
  let tplArrayBuffer=null;
  async function fetchTemplate(){
    try{
      const resp=await fetch('LP_template.docx'); if(!resp.ok) throw new Error();
      tplArrayBuffer=await resp.arrayBuffer(); status('Šablona načtena');
    }catch(e){ status('Čekám na šablonu', true); }
  }
  fetchTemplate();

  // Generate DOCX
  async function generateDocx(){
    if(!tplArrayBuffer){ alert('Nejdřív načti šablonu.'); return; }
    status('Generuji…');
    let doc;
    try{
      const data=tplArrayBuffer instanceof ArrayBuffer? new Uint8Array(tplArrayBuffer): tplArrayBuffer;
      const zip=new PizZip(data);
      // detekce konstruktoru Docxtemplater podle CDN
    let DocxT;
    if (window.docxtemplater) {
      DocxT = window.docxtemplater.default || window.docxtemplater;
    }
    if (!DocxT && window.Docxtemplater) {
      DocxT = window.Docxtemplater;
    }
    if (!DocxT) throw new Error('Docxtemplater konstruktor nelze najít');
    doc = new DocxT(zip, {paragraphLoop:true,linebreaks:true,nullGetter:()=>''});(zip,{paragraphLoop:true,linebreaks:true,nullGetter:()=>''});
    }catch(e){ console.error(e); status('Chyba šablony', true); alert('Šablonu nelze načíst'); return; }
    const ctx={
      jmeno:document.getElementById('jmeno').value,
      narozeni:document.getElementById('narozeni').value,
      adresa:document.getElementById('adresa').value,
      psc:document.getElementById('psc').value,
      pozice:document.getElementById('pozice').value,
      pobocka:document.getElementById('pobocka').value,
      konzultant:document.getElementById('konzultant').value,
      datum:new Date().toLocaleDateString('cs-CZ'),
      pozice_popis:document.getElementById('pozice_popis').value,
      popis_pozice:POSITION_DESCRIPTIONS[document.getElementById('pozice_popis').value]||''
    };
    document.querySelectorAll('#factors select').forEach(sel=>{ ctx[sel.dataset.key]=sel.value; });
    try{ doc.render(ctx); }catch(e){ console.error(e); status('Chyba renderu', true); alert('Chyba v šabloně'); return; }
    try{ const out=doc.getZip().generate({type:'blob'}); saveAs(out,`LP_${ctx.jmeno.split(' ').pop()||'posudek'}.docx`); status('Staženo'); }
    catch(e){ console.error(e); status('Chyba stah.', true); alert('Nelze stáhnout'); }
  }
  document.getElementById('genDocx').addEventListener('click', generateDocx);
  </script>
</body>
</html>
