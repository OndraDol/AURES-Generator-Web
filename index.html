<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <title>AURES Generátor LP</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" href="data:,">
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f5f5f5;margin:0;padding:20px;color:#222}
    h1{font-size:26px;margin:0 0 20px}
    .row{display:flex;gap:12px;margin-bottom:12px;align-items:center}
    label{width:140px;font-weight:600}
    input,select{flex:1;min-width:200px;padding:6px;border:1px solid #ccc;border-radius:4px}
    button{padding:10px 18px;background:#007ACC;color:#fff;border:none;border-radius:4px;cursor:pointer}
    button:disabled{background:#ccc;cursor:not-allowed}
    #dropZone{border:2px dashed #888;padding:20px;text-align:center;margin:20px 0;border-radius:6px;background:#fff;cursor:pointer}
    #dropZone.drag{border-color:#007ACC;background:#eef6ff}
    #status{margin-top:14px;font-size:14px;min-height:18px}
  </style>

  <!-- knihovny -->
  <script defer src="https://cdn.jsdelivr.net/npm/pizzip@3.1.1/dist/pizzip.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
</head>
<body>
  <h1>AURES Generátor LP</h1>

  <div id="dropZone">
    Přetáhni PDF sem nebo klikni
    <input type="file" id="fileInput" accept="application/pdf" hidden>
  </div>

  <div class="row"><label>Jméno</label><input id="jmeno"></div>
  <div class="row"><label>Datum narození</label><input id="narozeni"></div>
  <div class="row"><label>Adresa</label><input id="adresa"></div>
  <div class="row"><label>PSČ</label><input id="psc"></div>

  <h3>Faktory a kategorie (1–6)</h3>
  <div id="factors"></div>

  <div class="row"><label>Pobočka</label><select id="pobocka"></select></div>
  <div class="row"><label>Pozice</label><input id="pozice" value="Prodejce"></div>
  <div class="row"><label>Konzultant</label><select id="konzultant"></select></div>
  <div class="row"><label>Pozice popis</label><select id="pozice_popis"></select></div>

  <div class="row"><button id="genDocx" disabled>Generovat DOCX</button></div>
  <p id="status"></p>

<script>
// Po načtení stránky
window.addEventListener('DOMContentLoaded', () => {
  /********************
   * 1) Nastavení PDF.js
   *******************/
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';

  // zkrácený selektor
  const $ = id => document.getElementById(id);
  const msg = (t, err=false) => { const el=$('status'); el.textContent=t; el.style.color = err? '#b00':'#006400'; console.log(t); };

  /********************
   * 2) Číselníky z Python appky
   *******************/
  const FACTOR = [
    "Zátěž chladem","Fyzická zátěž","Pracovní poloha","Hluk","Vibrace","Prach","Chemické látky a směsi","------------------","Biologické činitele","Činnosti epidemiologicky závažné","Elektrotechnik dle vyhl č.50 / 1978 Sb.","Neionizující záření","Obsluha tlakových nádob a zařízení vys. napětí","Obsluha transport. a vysokozdvižných vozíků","Obsluha transport. vytáhů a jeřábů a vázaní břemen","Práce v noci","Práce ve výškách a nad volnou hloubkou","Psychická zátěž","Řidič v pracovněprávním vztahu do 7,5 tuny","Řidič v pracovněprávním vztahu nad 7,5 tuny","Vyšetření v základním rozsahu","Zátež teplem","Zraková zátěž"
  ];
  const CAT = ["","Kat. 1","Kat. 2","Kat. 3","Kat. 4"];
  const BRANCH_LIST = ["Brno","Chomutov","České Budějovice","Čestlice","Hradec Králové","Jihlava","Kladno","Kolín","Liberec","Mladá Boleslav","Olomouc","Opava","Ostrava","Pardubice","Plzeň","Praha","Sokolov","Tábor","Teplice","Ústí nad Labem","Valašské Meziříčí","Zlín","Znojmo"];
  const CONSULT_LIST = ["Anna Brůčková","Anna Kučerová","Alžběta Čermáková","Blanka Poliaková","Jan Jarma","Kamila Hušková","Karolína Kulvaitová","Miroslava Válková","Ondřej Dolejš"];
  const POS_DESC = {
    "Call Centrum": "Činnost spojená s jednáním s klienty/zaměstnanci po telefonu, prací na počítači a administrativními úkony. Provoz: dvousměnný, Pracovní doba: 8 hodinové směny (pondělí - neděle) v průměru 40 hodin/týdně.",
    "Manažer/Zástupce manažera": "Administrativní činnost spojená s prací na počítači, s vedením pracovního týmu a jednání s klienty. Součástí práce je řízení služebního vozidla. Provoz: jednosměnný, Pracovní doba: 12 hodinové směny (krátký/dlouhý týden)",
    "Prodejce": "Činnost spojená s prací na počítači a jednání s klienty. Součástí práce je řízení vozidla. Práce je vykonávaná v administrativních budovách a zároveň ve venkovních prostorech. V zimních měsících není překročena hranice čtyř hodin za pracovní dobu, kdyby zaměstnanci byli vystaveni operativní teplotě +4 °C a nižší. Práce prodejce je spojená se střídáním pobytu v teple a v chladu. Provoz: jednosměnný, Pracovní doba: 12 hodinové směny (krátký/dlouhý týden)",
    "Nákupčí / Testovací technik": "Administrativní činnost spojená s prací na počítači a jednání s klienty. Součástí práce je řízení vozidla. Občasný pohyb ve venkovních prostorech. Provoz: jednosměnný, Pracovní doba: 12 hodinové směny (krátký/dlouhý týden)",
    "Mobilní nákupčí": "Administrativní činnost spojená s prací na počítači a jednání s klienty. Součástí práce je řízení vozidla (více než 60 %). Občasný pohyb ve venkovních prostorech. Provoz: jednosměnný, Pracovní doba: 12 hodinové směny (krátký/dlouhý týden)",
    "Specialista zákaznického servisu": "Administrativní činnost spojená s prací na počítači a jednání s klienty. Provoz: jednosměnný, Pracovní doba: 12 hodinové směny (krátký/dlouhý týden)",
    "Mobilní Specialista zákaznického servisu": "Administrativní činnost spojená s prací na počítači a jednání s klienty. Součástí práce je řízení vozidla. Provoz: jednosměnný, Pracovní doba: 12 hodinové směny (krátký/dlouhý týden)",
    "Administrativa": "Administrativní činnost spojená s prací na počítači, zakládáním složek a jednání se zaměstnanci/klienty. Provoz: jednosměnný, Pracovní doba: 8 hodinové směny (pondělí – pátek)",
    "Operační tým/Pracovník podpory prodeje/Vedoucí úseku/Mobilní pracovník podpory prodeje": "Drobné práce v dílně, mytí a čištění automobilů, část pracovní doby je práce venku. Součástí práce je řízení vozidla. Práce s chemickými látkami s H314, H340, H350, H372. Provoz: jednosměnný, Pracovní doba: 12 hodinové směny (krátký/dlouhý týden)",
    "Uklízečka": "Provádí úklidové práce, mytí, čištění, vynášení odpadků. Provoz: jednosměnný, Pracovní doba: 8 hodinové směny (pondělí – pátek)",
    "Stock kontrolor": "Převoz automobilů v objektu společnosti, kontrola vozového parku, občasná práce s počítačem. Součástí práce je řízení vozidla. Provoz: jednosměnný, Pracovní doba: 8 hodinové směny (pondělí – pátek)",
    "Řidič do 7,5t/ Kurýr": "Provádí přepravu zákazníků a vozidel. Součástí práce je řízení vozidla. Provoz: jednosměnný, Pracovní doba: 8 hodinové směny (pondělí – pátek)",
    "Řidič nad 7,5t": "Provádí přepravu vozů mezi pobočkami, nakládka a vykládka vozů. Součástí práce je řízení vozidla nad 7,5 tuny. Provoz: jednosměnný, Pracovní doba: 8 hodinové směny (pondělí – pátek)",
    "Technik se zaměřením na opravy detailů": "Provádí drobné opravy detailů vozu. Součástí práce je řízení vozidla. Provoz: jednosměnný, Pracovní doba: 8 hodinové směny (pondělí – pátek)",
    "Mechanik": "Provádí údržbu, opravy a seřizování silničních motorových vozidel. Práce s chemickými látkami s H314. Součástí práce je řízení vozidla. Provoz: jednosměnný, Pracovní doba: 8 hodinové směny (pondělí – pátek)",
    "Výpomoc při přepravě vozů mezi pobočkami": "Provádí přepravu zákazníků a vozidel. Součástí práce je řízení vozidla. Provoz: jednosměnný, DPP spolupráce.",
    "Výpomoc při prodeji vozů": "Činnost spojená s prací na počítači a jednání s klienty. Součástí práce je řízení vozidla. Práce je vykonávaná v administrativních budovách a zároveň ve venkovních prostorech. V zimních měsících není překročena hranice čtyř hodin za pracovní dobu, kdyby zaměstnanci byli vystaveni operativní teplotě +4 °C a nižší. Práce je spojená se střídáním pobytu v teple a v chladu. Povaha práce nárazová (dohoda o provedení práce), směny maximálně 8 hodinové."
  };

  // util pro select
  const fill = (sel, arr) => { sel.innerHTML=''; arr.forEach(v=>sel.add(new Option(v,v))); };

  /********************
   * 3) Vykreslení dropdownů
   *******************/
  fill($('pobocka'), BRANCH_LIST);
  fill($('konzultant'), CONSULT_LIST);
  fill($('pozice_popis'), Object.keys(POS_DESC));

  // šest řádků faktor/kategorie
  for(let i=1;i<=6;i++){
    const row=document.createElement('div');row.className='row';
    const sf=document.createElement('select');sf.id='faktor'+i;fill(sf,FACTOR);
    const sk=document.createElement('select');sk.id='kategorie'+i;fill(sk,CAT);
    if(i===1){ sf.value="Vyšetření v základním rozsahu"; sk.value="Kat. 1"; }
    row.append(sf,sk); $('factors').append(row);
  }

  /********************
   * 4) Drag&drop PDF
   *******************/
  const dz=$('dropZone'), fi=$('fileInput');
  dz.onclick=()=>fi.click();
  ['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.classList.add('drag');}));
  ['dragleave','drop'].forEach(ev=>dz.addEventListener(ev,()=>dz.classList.remove('drag')));
  dz.ondrop=e=>{e.preventDefault();if(e.dataTransfer.files[0]) handlePDF(e.dataTransfer.files[0]);};
  fi.onchange=e=>{if(e.target.files[0]) handlePDF(e.target.files[0]);};

  async function handlePDF(file){
    msg('Čtu PDF…'); $('genDocx').disabled=true;
    try{
      const data=new Uint8Array(await file.arrayBuffer());
      const pdf=await pdfjsLib.getDocument({data}).promise;
      const page=await pdf.getPage(1);
      const ann=await page.getAnnotations({intent:'display'});
      const get=name=>ann.find(a=>a.fieldName?.trim()===name)?.fieldValue||'';
      $('jmeno').value=get('jmeno');
      $('narozeni').value=(get('narozeni')||'').split('/')[0].trim();
      $('adresa').value=[get('trvale-bydliste-ulice'),get('trvale-bydliste-mesto')].filter(Boolean).join(', ');
      $('psc').value=get('trvale-bydliste-psc');
      msg('PDF načteno'); $('genDocx').disabled=false;
    }catch(err){console.error(err);msg('Chyba při čtení PDF',true);}  }

  /********************
   * 5) Načtení DOCX šablony
   *******************/
  let tplBuf=null;
  fetch('LP_template.docx').then(r=>r.ok?r.arrayBuffer():Promise.reject()).then(b=>{tplBuf=b;msg('Šablona načtena');}).catch(()=>msg('Šablonu LP_template.docx nelze načíst',true));

  const esc = s=>s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  const replaceVar = (xml,key,val)=>xml.replace(new RegExp(`(<w:t[^>]*>)\\s*${key}\\s*(</w:t>)`,'g'),`$1${esc(val)}$2`);
  const stripPlaceholders = xml=>xml.replace(/<w:placeholder[\s\S]*?<\/w:placeholder>/g,'').replace(/<w:placeholder[^>]*?\/>/g,'');

  /********************
   * 6) Generování DOCX
   *******************/
  $('genDocx').addEventListener('click',()=>{
    if(!tplBuf){alert('Nejdřív načti šablonu');return;}
    msg('Generuji…');
    const zip=new PizZip(new Uint8Array(tplBuf));
    let xml=zip.file('word/document.xml').asText();
    const ctx={
      jmeno:$('jmeno').value,
      narozeni:$('narozeni').value,
      adresa:$('adresa').value,
      psc:$('psc').value,
      pozice:$('pozice').value,
      konzultant:$('konzultant').value,
      pozice_popis:$('pozice_popis').value,
      popis_pozice:POS_DESC[$('pozice_popis').value]||'',
      pobocka:$('pobocka').value,
      datum:new Date().toLocaleDateString('cs-CZ')
    };
    Object.entries(ctx).forEach(([k,v])=>{xml=replaceVar(xml,k,v);});
    for(let i=1;i<=6;i++){
      xml=replaceVar(xml,`faktor${i}`,$('faktor'+i).value);
      xml=replaceVar(xml,`kat${i}`,$('kategorie'+i).value);
    }
    xml=stripPlaceholders(xml);
    zip.file('word/document.xml',xml);
    const blob=zip.generate({type:'blob',mimeType:'application/vnd.openxmlformats-officedocument.wordprocessingml.document'});
    const surname=(ctx.jmeno.split(' ').pop()||'posudek');
    saveAs(blob,`LP_${surname}.docx`);
    msg('Hotovo – soubor stažen');
  });
});
</script>

</body>
</html>
