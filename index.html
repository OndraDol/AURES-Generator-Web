<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8">
<title>AURES Generátor LP</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" href="data:,">

<style>
 body{font-family:Arial,Helvetica,sans-serif;background:#f5f5f5;margin:0;padding:20px;color:#222}
 h1{font-size:26px;margin:0 0 20px}
 .row{display:flex;gap:12px;margin-bottom:10px;align-items:center}
 label{width:140px;font-weight:600}
 input,select{flex:1;min-width:200px;padding:6px;border:1px solid #ccc;border-radius:4px}
 button{padding:8px 16px;background:#007acc;color:#fff;border:none;border-radius:4px;cursor:pointer}
 button:disabled{background:#ccc;cursor:not-allowed}
 #drop{border:2px dashed #888;padding:20px;text-align:center;margin:20px 0;border-radius:6px;background:#fff}
 #drop.drag{border-color:#007acc;background:#eef6ff}
 #status{margin-top:12px;font-size:14px;min-height:18px}
</style>

<!-- externí knihovny -->
<script defer src="https://unpkg.com/docxtemplater@3.29.0/build/docxtemplater.pizzip.min.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/file-saver/2.0.5/FileSaver.min.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"
        crossorigin="anonymous"></script>
</head>

<body>
<h1>AURES Generátor LP</h1>

<div id="drop">
  Přetáhni PDF nebo klikni
  <input type="file" id="file" accept="application/pdf" hidden>
</div>

<div class="row"><label>Jméno</label><input id="jmeno"></div>
<div class="row"><label>Datum narození</label><input id="narozeni"></div>
<div class="row"><label>Adresa</label><input id="adresa"></div>
<div class="row"><label>PSČ</label><input id="psc"></div>

<h3>Faktory (1 – 6)</h3>
<div id="factors"></div>

<div class="row"><label>Pobočka</label>
  <select id="pobocka">
    <option>Praha</option><option>Brno</option><option>Ostrava</option>
  </select>
</div>
<div class="row"><label>Pozice</label><input id="pozice" value="Prodejce"></div>
<div class="row"><label>Konzultant</label>
  <select id="konzultant">
    <option>Jan Novák</option><option>Petra Dvořáková</option>
  </select>
</div>

<div class="row"><button id="gen" disabled>Generovat DOCX</button></div>
<p id="status"></p>

<!-- === vlastní skript až po DOM === -->
<script>
/* ---------- prvky ---------- */
const qs=id=>document.getElementById(id);
const statusEl = qs('status');

/* ---------- helper na stav ---------- */
function setStatus(msg, err=false){
  statusEl.textContent = msg;
  statusEl.style.color = err ? '#b00' : '#006400';
}

/* ---------- faktory = 6 řádků ---------- */
const factorsWrap = qs('factors');
for(let i=1;i<=6;i++){
  const row=document.createElement('div');row.className='row';
  const lab=document.createElement('label');lab.textContent=`Faktor ${i}`;
  const sel=document.createElement('select');sel.id=`faktor_${i}`;
  for(let k=1;k<=6;k++) sel.add(new Option(k,k));
  row.append(lab,sel);factorsWrap.append(row);
}

/* ---------- drag & click ---------- */
const drop = qs('drop');
drop.addEventListener('click',()=>qs('file').click());
['dragenter','dragover'].forEach(e=>drop.addEventListener(e,x=>{
  x.preventDefault(); drop.classList.add('drag');
}));
['dragleave','drop'].forEach(e=>drop.addEventListener(e,()=>drop.classList.remove('drag')));
drop.addEventListener('drop',e=>{
  e.preventDefault();
  if(e.dataTransfer.files[0]) handlePDF(e.dataTransfer.files[0]);
});
qs('file').addEventListener('change',e=>{
  if(e.target.files[0]) handlePDF(e.target.files[0]);
});

/* ---------- PDF → formulář ---------- */
async function handlePDF(file){
  if(file.type!=='application/pdf'){setStatus('Není PDF',true);return;}
  setStatus('Čtu PDF…'); qs('gen').disabled = true;
  try{
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const uint=new Uint8Array(await file.arrayBuffer());
    const pdf=await pdfjsLib.getDocument({data:uint}).promise;
    const ann=(await pdf.getPage(1)).getAnnotations();
    const get=fn=>ann.find(a=>a.fieldName?.trim()===fn)?.fieldValue||'';

    qs('jmeno').value = get('jmeno');
    qs('narozeni').value = (get('narozeni')||'').split('/')[0];
    qs('adresa').value =
      [get('trvale-bydliste-ulice'), get('trvale-bydliste-mesto')]
      .filter(Boolean).join(', ');
    qs('psc').value = get('trvale-bydliste-psc');

    setStatus('PDF načteno – můžeš generovat'); qs('gen').disabled = false;
  }catch(e){console.error(e); setStatus('Chyba při čtení PDF', true);}
}

/* ---------- DOCX ---------- */
qs('gen').addEventListener('click', async ()=>{
  setStatus('Načítám šablonu…'); qs('gen').disabled = true;
  try{
    const res = await fetch('LP_template.docx');
    if(!res.ok) throw new Error('Šablona LP_template.docx chybí');
    const zip = new PizZip(await res.arrayBuffer());

    const Doc = window.docxtemplater;          // balík exportuje takto
    if(typeof Doc!=='function') throw new Error('Docxtemplater se nenačetl');

    const doc = new Doc(zip,{paragraphLoop:true,linebreaks:true,nullGetter:()=>''});
    const ctx = {
      jmeno:qs('jmeno').value,
      narozeni:qs('narozeni').value,
      adresa:qs('adresa').value,
      psc:qs('psc').value,
      pobocka:qs('pobocka').value,
      pozice:qs('pozice').value,
      konzultant:qs('konzultant').value,
      datum:new Date().toLocaleDateString('cs-CZ')
    };
    for(let i=1;i<=6;i++) ctx[`faktor_${i}`] = qs(`faktor_${i}`).value;

    doc.render(ctx);
    const blob = doc.getZip().generate({type:'blob'});
    saveAs(blob,`LP_${(ctx.jmeno||'soubor').replace(/\s+/g,'_')}.docx`);
    setStatus('DOCX stažen');
  }catch(e){console.error(e); setStatus(e.message,true);}
  qs('gen').disabled = false;
});
</script>
</body>
</html>
