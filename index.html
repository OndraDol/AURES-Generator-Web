<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <title>AURES Generátor LP v2</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" href="data:,">
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f5f5f5;margin:0;padding:20px;color:#222}
    h1{font-size:26px;margin:0 0 20px}
    .row{display:flex;gap:12px;margin-bottom:12px;align-items:center}
    label{width:140px;font-weight:600}
    input,select{flex:1;min-width:200px;padding:6px;border:1px solid #ccc;border-radius:4px}
    button{padding:10px 18px;background:#007ACC;color:#fff;border:none;border-radius:4px;cursor:pointer}
    button:disabled{background:#ccc;cursor:not-allowed}
    #dropZone{border:2px dashed #888;padding:20px;text-align:center;margin:20px 0;border-radius:6px;background:#fff;cursor:pointer}
    #dropZone.drag{border-color:#007ACC;background:#eef6ff}
    #status{margin-top:14px;font-size:14px;min-height:18px}
  </style>

  <script defer src="https://cdn.jsdelivr.net/npm/pizzip@3.1.1/dist/pizzip.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
</head>
<body>
  <h1>AURES Generátor LP</h1>

  <div id="dropZone">
    Přetáhni PDF sem nebo klikni
    <input type="file" id="fileInput" accept="application/pdf" hidden>
  </div>

  <div class="row"><label>Jméno</label><input id="jmeno"></div>
  <div class="row"><label>Datum narození</label><input id="narozeni"></div>
  <div class="row"><label>Adresa</label><input id="adresa"></div>
  <div class="row"><label>PSČ</label><input id="psc"></div>

  <h3>Faktory a kategorie (1–6)</h3>
  <div id="factors"></div>

  <div class="row"><label>Pobočka</label><select id="pobocka"></select></div>
  <div class="row"><label>Pozice</label><input id="pozice" value="Prodejce"></div>
  <div class="row"><label>Konzultant</label><select id="konzultant"></select></div>
  <div class="row"><label>Pozice popis</label><select id="pozice_popis"></select></div>

  <div class="row"><button id="genDocx" disabled>Generovat DOCX</button></div>
  <p id="status"></p>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // ---------- PDF.js nastavení ----------
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';

    const $ = id => document.getElementById(id);
    const statusEl = $('status');
    const msg = (t, err=false) => {
      statusEl.textContent = t;
      statusEl.style.color = err ? '#b00' : '#006400';
      console.log(t);
    };

    // ---------- Číselníky ----------
    const FACTOR = [ /* 23 faktorů */ ];
    const CAT = ["","Kat. 1","Kat. 2","Kat. 3","Kat. 4"];
    const BRANCH_LIST = [ /* 22 poboček */ ];
    const CONSULT_LIST = [ /* 9 konzultantů */ ];
    const POS_DESC = { /* 10 popisů pozic */ };

    const fill = (sel, arr) => { sel.innerHTML=''; arr.forEach(v => sel.add(new Option(v,v))); };
    fill($('pobocka'), BRANCH_LIST);
    fill($('konzultant'), CONSULT_LIST);
    fill($('pozice_popis'), Object.keys(POS_DESC));

    // faktory + kategorie selecty
    for (let i = 1; i <= 6; i++) {
      const row = document.createElement('div'); row.className='row';
      const sf = document.createElement('select'); sf.id='faktor'+i;
      const sk = document.createElement('select'); sk.id='kategorie'+i;
      fill(sf, FACTOR); fill(sk, CAT);
      if (i===1) { sf.value="Vyšetření v základním rozsahu"; sk.value="Kat. 1"; }
      row.append(sf, sk); $('factors').append(row);
    }

    // ---------- Drag & drop PDF ----------
    const dz = $('dropZone'), fi = $('fileInput');
    dz.onclick = () => fi.click();
    ['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.classList.add('drag');}));
    ['dragleave','drop'].forEach(ev=>dz.addEventListener(ev,()=>dz.classList.remove('drag')));
    dz.ondrop = e => { e.preventDefault(); if (e.dataTransfer.files[0]) handlePDF(e.dataTransfer.files[0]); };
    fi.onchange = e => { if (e.target.files[0]) handlePDF(e.target.files[0]); };

    async function handlePDF(file) {
      msg('Čtu PDF…'); $('genDocx').disabled=true;
      try {
        const data = new Uint8Array(await file.arrayBuffer());
        const pdf = await pdfjsLib.getDocument({ data }).promise;
        const page = await pdf.getPage(1);
        const ann = await page.getAnnotations({ intent:'display' });
        const get = name => ann.find(a=>a.fieldName?.trim()===name)?.fieldValue||'';
        $('jmeno').value=get('jmeno');
        $('narozeni').value=(get('narozeni')||'').split('/')[0].trim();
        $('adresa').value=[get('trvale-bydliste-ulice'),get('trvale-bydliste-mesto')].filter(Boolean).join(', ');
        $('psc').value=get('trvale-bydliste-psc');
        msg('PDF načteno'); $('genDocx').disabled=false;
      } catch(e) {
        console.error(e); msg('Chyba při čtení PDF', true);
      }
    }

    // ---------- Načtení DOCX šablony ----------
    let tplBuf=null;
    fetch('LP_template.docx')
      .then(r=>r.ok? r.arrayBuffer():Promise.reject())
      .then(b=>{tplBuf=b;msg('Šablona načtena');})
      .catch(()=>msg('Šablonu LP_template.docx nelze načíst',true));

    // ---------- Pomocné funkce ----------
    const esc = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

    // nahrazení obsahu <w:t>…</w:t>
    const replaceVar = (xml,key,val) => {
      const safe = esc(val);
      const re = new RegExp(`(<w:t[^>]*>)\\s*${key}\\s*(</w:t>)`,'g');
      return xml.replace(re, `$1${safe}$2`);
    };

    // odstranění w:placeholder (aby Word neukazoval šedý hint místo textu)
    const stripPlaceholders = xml => xml
      .replace(/<w:placeholder[\s\S]*?<\/w:placeholder>/g,'')
      .replace(/<w:placeholder[^>]*?\/>/g,'');

    // ---------- Generování DOCX ----------
    $('genDocx').addEventListener('click', () => {
      if (!tplBuf) { alert('Nejdřív načti šablonu'); return; }

      msg('Generuji…');
      const zip = new PizZip(new Uint8Array(tplBuf));
      let xml = zip.file('word/document.xml').asText();

      // Kontext pro nahrazení
      const ctx = {
        jmeno:$('jmeno').value,
        narozeni:$('narozeni').value,
        adresa:$('adresa').value,
        psc:$('psc').value,
        pozice:$('pozice').value,
        konzultant:$('konzultant').value,
        pozice_popis:$('pozice_popis').value,
        popis_pozice:POS_DESC[$('pozice_popis').value]||'',
        pobocka:$('pobocka').value,
        datum:new Date().toLocaleDateString('cs-CZ')
      };

      // Statické položky
      Object.entries(ctx).forEach(([k,v])=>{ xml = replaceVar(xml,k,v); });

      // Faktory + kategorie
      for (let i=1;i<=6;i++) {
        xml = replaceVar(xml,`faktor${i}`,$('faktor'+i).value);
        xml = replaceVar(xml,`kat${i}`,$('kategorie'+i).value);
      }

      // Odstraníme placeholdery, ať Word neignoruje obsah
      xml = stripPlaceholders(xml);

      // Zapíšeme zpět a stáhneme
      zip.file('word/document.xml', xml);
      const blob = zip.generate({ type:'blob', mimeType:'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
      saveAs(blob, `LP_${(ctx.jmeno.split(' ').pop()||'posudek')}.docx`);
      msg('Hotovo – soubor stažen');
    });
  });
  </script>
</body>
</html>
