<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8">
<title>AURES Generátor LP</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" href="data:,">

<style>
 body{font-family:Arial,Helvetica,sans-serif;background:#f5f5f5;margin:0;padding:20px;color:#222}
 h1{font-size:26px;margin:0 0 20px}
 .row{display:flex;gap:12px;margin-bottom:10px;align-items:center}
 label{width:140px;font-weight:600}
 input,select{flex:1;min-width:200px;padding:6px;border:1px solid #ccc;border-radius:4px}
 button{padding:8px 16px;background:#007acc;color:#fff;border:none;border-radius:4px;cursor:pointer}
 button:disabled{background:#ccc;cursor:not-allowed}
 #drop{border:2px dashed #888;padding:20px;text-align:center;margin:20px 0;border-radius:6px;background:#fff}
 #drop.drag{border-color:#007acc;background:#eef6ff}
 #status{margin-top:12px;font-size:14px;min-height:18px}
</style>

<!-- jediný balík = docxtemplater + PizZip -->
<script src="https://unpkg.com/docxtemplater@3.29.0/build/docxtemplater.pizzip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/file-saver/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous"></script>
</head>
<body>

<h1>AURES Generátor LP</h1>

<div id="drop">Přetáhni PDF nebo klikni<input type="file" id="file" accept="application/pdf" hidden></div>

<div class="row"><label>Jméno</label><input id="jmeno"></div>
<div class="row"><label>Datum narození</label><input id="narozeni"></div>
<div class="row"><label>Adresa</label><input id="adresa"></div>
<div class="row"><label>PSČ</label><input id="psc"></div>

<div class="row"><label>Pobočka</label><select id="pobocka">
  <option>Praha</option><option>Brno</option><option>Ostrava</option></select></div>
<div class="row"><label>Pozice</label><input id="pozice" value="Prodejce"></div>
<div class="row"><label>Konzultant</label><select id="konzultant">
  <option>Jan Novák</option><option>Petra Dvořáková</option></select></div>

<div class="row"><button id="gen" disabled>Generovat DOCX</button></div>
<p id="status"></p>

<script>
/* ====== helpers ====== */
const $=id=>document.getElementById(id);
const setStatus=(t,err=false)=>{$('status').textContent=t;$('status').style.color=err?'#b00':'#006400';};

/* ====== drag & click ====== */
$('drop').addEventListener('click',()=>$('file').click());
['dragenter','dragover'].forEach(ev=>$('drop').addEventListener(ev,e=>{
  e.preventDefault();$('drop').classList.add('drag');}));
['dragleave','drop'].forEach(ev=>$('drop').addEventListener(ev,()=>$('drop').classList.remove('drag')));
$('drop').addEventListener('drop',e=>{
  e.preventDefault();if(e.dataTransfer.files[0]) loadPDF(e.dataTransfer.files[0]);});
$('file').addEventListener('change',e=>{if(e.target.files[0]) loadPDF(e.target.files[0]);});

/* ====== načtení PDF ====== */
async function loadPDF(file){
  if(file.type!=='application/pdf'){setStatus('Není PDF',true);return;}
  setStatus('Čtu PDF…');$('gen').disabled=true;
  try{
    const bytes=new Uint8Array(await file.arrayBuffer());
    const pdf=await pdfjsLib.getDocument({data:bytes}).promise;
    const ann=(await pdf.getPage(1)).getAnnotations();
    const get=fn=>{const w=ann.find(a=>a.fieldName?.trim()===fn);return w?.fieldValue||'';};
    $('jmeno').value=get('jmeno');
    $('narozeni').value=(get('narozeni')||'').split('/')[0];
    $('adresa').value=[get('trvale-bydliste-ulice'),get('trvale-bydliste-mesto')].filter(Boolean).join(', ');
    $('psc').value=get('trvale-bydliste-psc');
    setStatus('PDF ok – můžeš generovat');$('gen').disabled=false;
  }catch(e){console.error(e);setStatus('Chyba PDF',true);}
}

/* ====== generování DOCX ====== */
$('gen').addEventListener('click',async()=>{
  setStatus('Načítám šablonu…');$('gen').disabled=true;
  try{
    const res=await fetch('LP_template.docx');if(!res.ok) throw new Error('Šablona nenalezena');
    const zip=new PizZip(await res.arrayBuffer());
    const Doc=window.docxtemplater;         // v tomto balíku je to vždy lower-case
    if(typeof Doc!=='function') throw new Error('Docxtemplater nenačten');

    const doc=new Doc(zip,{paragraphLoop:true,linebreaks:true,nullGetter:()=>''});
    doc.render({
      jmeno:$('jmeno').value,
      narozeni:$('narozeni').value,
      adresa:$('adresa').value,
      psc:$('psc').value,
      pobocka:$('pobocka').value,
      pozice:$('pozice').value,
      konzultant:$('konzultant').value,
      datum:new Date().toLocaleDateString('cs-CZ')
    });
    const blob=doc.getZip().generate({type:'blob'});
    saveAs(blob,`LP_${($('jmeno').value||'soubor').replace(/\s+/g,'_')}.docx`);
    setStatus('Hotovo – soubor stažen');
  }catch(e){console.error(e);setStatus(e.message,true);}
  $('gen').disabled=false;
});
</script>
</body>
</html>
