<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8">
<title>AURES Generátor LP v9</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f5f5f5;margin:0;padding:20px;color:#222}
  h1{font-size:26px;margin:0 0 20px}
  .row{display:flex;gap:12px;margin-bottom:12px;align-items:center;flex-wrap:wrap}
  label{width:140px;font-weight:600}
  input,select{flex:1;min-width:200px;padding:6px;border:1px solid #ccc;border-radius:4px}
  button{padding:10px 18px;background:#007ACC;color:#fff;border:none;border-radius:4px;cursor:pointer}
  button:disabled{background:#ccc;cursor:not-allowed}
  #dropZone{border:2px dashed #888;padding:20px;text-align:center;margin:20px 0;border-radius:6px;background:#fff;cursor:pointer;transition:.2s}
  #dropZone.drag{border-color:#007ACC;background:#eef6ff}
  #status{margin-top:14px;font-size:14px;min-height:18px}
</style>

<!-- knihovny -->
<script defer src="https://cdn.jsdelivr.net/npm/pizzip@3.1.1/dist/pizzip.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/docxtemplater@3.27.0/build/docxtemplater.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
</head>
<body>
<h1>AURES Generátor LP</h1>

<div id="dropZone">
  Přetáhni PDF sem nebo klikni
  <input type="file" id="fileInput" accept="application/pdf" hidden>
</div>

<div class="row"><label>Jméno</label><input id="jmeno"></div>
<div class="row"><label>Datum narození</label><input id="narozeni" placeholder="DD.MM.RRRR"></div>
<div class="row"><label>Adresa</label><input id="adresa"></div>
<div class="row"><label>PSČ</label><input id="psc"></div>

<h3>Faktory a kategorie (1–6)</h3>
<div id="factors"></div>

<div class="row"><label>Pobočka</label><select id="pobocka"></select></div>
<div class="row"><label>Pozice</label><input id="pozice" value="Prodejce"></div>
<div class="row"><label>Konzultant</label><select id="konzultant"></select></div>
<div class="row"><label>Popis pozice</label><select id="pozice_popis"></select></div>

<div class="row"><button id="genDocx" disabled>Generovat DOCX</button></div>
<p id="status"></p>

<script>
document.addEventListener('DOMContentLoaded',()=>{

/* ---------- 1) nastavení pdf.js ---------- */
pdfjsLib.GlobalWorkerOptions.workerSrc=
  'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';

/* ---------- 2) util ---------- */
const $=id=>document.getElementById(id);
const msg=(t,err=false)=>{ $('status').textContent=t; $('status').style.color=err?'#b00':'#006400'; };

/* ---------- 3) číselníky ---------- */
const FACTOR=[
  'Zátěž chladem','Fyzická zátěž','Pracovní poloha','Hluk','Vibrace','Prach','Chemické látky a směsi','------------------',
  'Biologické činitele','Činnosti epidemiologicky závažné','Elektrotechnik dle vyhl č.50 / 1978 Sb.','Neionizující záření',
  'Obsluha tlakových nádob a zařízení vys. napětí','Obsluha transport. a vysokozdvižných vozíků','Obsluha transport. vytáhů a jeřábů a vázaní břemen',
  'Práce v noci','Práce ve výškách a nad volnou hloubkou','Psychická zátěž',
  'Řidič v pracovněprávním vztahu do 7,5 tuny','Řidič v pracovněprávním vztahu nad 7,5 tuny',
  'Vyšetření v základním rozsahu','Zátěž teplem','Zraková zátěž'
];
const CAT=['','Kat. 1','Kat. 2','Kat. 3','Kat. 4'];
const BRANCH=[
  'Brno','Chomutov','České Budějovice','Čestlice','Hradec Králové','Jihlava','Kladno','Kolín','Liberec','Mladá Boleslav',
  'Olomouc','Opava','Ostrava','Pardubice','Plzeň','Praha','Sokolov','Tábor','Teplice','Ústí nad Labem',
  'Valašské Meziříčí','Zlín','Znojmo'
];
const CONSULT=[
  'Anna Brůčková','Anna Kučerová','Alžběta Čermáková','Blanka Poliaková','Jan Jarma',
  'Kamila Hušková','Karolína Kulvaitová','Miroslava Válková','Ondřej Dolejš'
];
const POS_DESC={
  'Call Centrum':'Činnost spojená s jednáním s klienty/zaměstnanci po telefonu, prací na počítači a administrativními úkony.',
  'Manažer/Zástupce manažera':'Administrativní činnost, vedení týmu, jednání s klienty, řízení služebního vozu.',
  'Prodejce':'Jednání s klienty, práce na PC, střídání pobytu uvnitř/venku, řízení vozidla.',
  'Nákupčí / Testovací technik':'Jednání s klienty, práce na PC, řízení vozidla, občas venku.',
  'Mobilní nákupčí':'Převážně řízení vozidla (>60 %), jednání s klienty, práce na PC.',
  'Specialista zákaznického servisu':'Administrativa a komunikace s klienty.',
  'Mobilní Specialista zákaznického servisu':'Administrativa, komunikace, řízení vozidla.',
  'Administrativa':'Práce na PC, zakládání složek, jednání se zaměstnanci/klienty.',
  'Operační tým/Pracovník podpory prodeje':'Mycí/dílenské práce, venkovní práce, řízení vozidla, chemikálie.',
  'Uklízečka':'Úklidové práce, mytí, čištění, odpad.',
  'Stock kontrolor':'Převoz aut v areálu, kontrola vozového parku, PC práce.',
  'Řidič do 7,5t/ Kurýr':'Přeprava zákazníků a vozidel, řízení vozidla.',
  'Řidič nad 7,5t':'Přeprava vozů mezi pobočkami, nakládka/vykládka, řízení vozidla >7,5 t.',
  'Technik se zaměřením na opravy detailů':'Drobné opravy, řízení vozidla.',
  'Mechanik':'Údržba, opravy a seřizování vozidel, práce s chemikáliemi.',
  'Výpomoc při přepravě vozů mezi pobočkami':'Přeprava vozů/zákazníků, řízení vozidla (DPP).',
  'Výpomoc při prodeji vozů':'Jednání s klienty, práce na PC, střídání teplo/chlad (DPP).'
};

/* ---------- 4) helper pro select ---------- */
const fill=(sel,arr)=>{ sel.innerHTML=''; arr.forEach(v=>sel.add(new Option(v,v))); };

fill($('pobocka'),BRANCH);
fill($('konzultant'),CONSULT);
fill($('pozice_popis'),Object.keys(POS_DESC));

/* ---------- 5) faktory + kategorie ---------- */
for(let i=1;i<=6;i++){
  const row=document.createElement('div');row.className='row';
  const sf=document.createElement('select'); sf.id='faktor'+i; fill(sf,FACTOR);
  const sk=document.createElement('select'); sk.id='kategorie'+i; fill(sk,CAT);
  if(i===1){ sf.value='Vyšetření v základním rozsahu'; sk.value='Kat. 1'; }
  row.append(sf,sk); $('factors').append(row);
}

/* ---------- 6) drag & drop ---------- */
const dz=$('dropZone'), fi=$('fileInput');
dz.onclick=()=>fi.click();
['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.classList.add('drag');}));
['dragleave','drop'].forEach(ev=>dz.addEventListener(ev,()=>dz.classList.remove('drag')));
dz.addEventListener('drop',e=>{e.preventDefault(); if(e.dataTransfer.files[0])loadPDF(e.dataTransfer.files[0]);});
fi.addEventListener('change',e=>{ if(e.target.files[0])loadPDF(e.target.files[0]); });

/* ---------- 7) načtení PDF ---------- */
async function loadPDF(file){
  msg('Čtu PDF…'); $('genDocx').disabled=true;
  try{
    const data=new Uint8Array(await file.arrayBuffer());
    const pdf=await pdfjsLib.getDocument({data}).promise;
    const page=await pdf.getPage(1);
    const ann=await page.getAnnotations({intent:'display'});
    const get=nm=>ann.find(a=>a.fieldName?.trim().toLowerCase()===nm.toLowerCase())?.fieldValue||'';
    $('jmeno').value=get('jmeno');
    $('narozeni').value=(get('narozeni')||'').split('/')[0].trim();
    $('adresa').value=[get('trvale-bydliste-ulice'),get('trvale-bydliste-mesto')].filter(Boolean).join(', ');
    $('psc').value=get('trvale-bydliste-psc');
    msg('PDF načteno');
    $('genDocx').disabled=false;
  }catch(e){ console.error(e); msg('Chyba při čtení PDF',true); }
}

/* ---------- 8) načti šablonu ---------- */
let templateBuf=null;
fetch('LP_template.docx')
  .then(r=>r.ok?r.arrayBuffer():Promise.reject())
  .then(b=>{templateBuf=b; msg('Šablona načtena');})
  .catch(()=>msg('Šablonu nelze načíst',true));

/* ---------- 9) generování DOCX ---------- */
$('genDocx').addEventListener('click',()=>{
  if(!templateBuf){ alert('Šablona chybí'); return; }
  try{
    msg('Generuji…'); const zip=new PizZip(templateBuf);
    const doc=new window.Docxtemplater(zip,{linebreaks:true});

    const data={
      jmeno:$('jmeno').value.trim(),
      narozeni:$('narozeni').value.trim(),
      adresa:$('adresa').value.trim(),
      psc:$('psc').value.trim(),
      pobocka:$('pobocka').value.trim(),
      pozice:$('pozice').value.trim(),
      konzultant:$('konzultant').value.trim(),
      pozice_popis:$('pozice_popis').value.trim(),
      popis_pozice:POS_DESC[$('pozice_popis').value.trim()]||'',
      datum:new Date().toLocaleDateString('cs-CZ')
    };
    for(let i=1;i<=6;i++){
      data['faktor'+i]=$('faktor'+i).value;
      data['kategorie'+i]=$('kategorie'+i).value;
    }

    doc.setData(data);
    doc.render();

    const out=doc.getZip().generate({type:'blob',mimeType:'application/vnd.openxmlformats-officedocument.wordprocessingml.document'});
    saveAs(out,`LP_${data.jmeno.replace(/\\s+/g,'_')}.docx`);
    msg('Hotovo – soubor stažen');
  }catch(err){ console.error(err); msg('Chyba generování',true); }
});

});
</script>
</body>
</html>
