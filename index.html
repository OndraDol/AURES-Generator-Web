<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <title>AURES Generátor LP</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f5f5f5;margin:0;padding:20px;color:#222}
    h1{font-size:26px;margin-bottom:20px}
    h3{margin-top:30px}
    .row{display:flex;gap:12px;margin-bottom:12px;align-items:center}
    label{width:140px;font-weight:600}
    input,select{flex:1;min-width:200px;padding:6px;border:1px solid #ccc;border-radius:4px}
    button{padding:10px 18px;background:#007ACC;color:#fff;border:none;border-radius:4px;cursor:pointer}
    button:disabled{background:#ccc;cursor:not-allowed}
    #dropZone{border:2px dashed #888;padding:20px;text-align:center;margin:20px 0;border-radius:6px;background:#fff;cursor:pointer}
    #dropZone.drag{border-color:#007ACC;background:#eef6ff}
    #status{margin-top:14px;font-size:14px;min-height:18px}
  </style>
  <!-- knihovny -->
  <script defer src="https://cdn.jsdelivr.net/npm/pizzip@3.1.1/dist/pizzip.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/docxtemplater@3.27.0/build/docxtemplater.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
</head>
<body>
  <h1>AURES Generátor LP</h1>

  <div id="dropZone">
    Přetáhni PDF sem nebo klikni
    <input type="file" id="fileInput" accept="application/pdf" hidden>
  </div>

  <div class="row"><label>Jméno</label><input id="jmeno"></div>
  <div class="row"><label>Datum narození</label><input id="narozeni"></div>
  <div class="row"><label>Adresa</label><input id="adresa"></div>
  <div class="row"><label>PSČ</label><input id="psc"></div>

  <h3>Faktory a kategorie</h3>
  <div id="factors"></div>

  <div class="row"><label>Pobočka</label><select id="pobocka"></select></div>
  <div class="row"><label>Pozice</label><input id="pozice" value="Prodejce"></div>
  <div class="row"><label>Konzultant</label><select id="konzultant"></select></div>
  <div class="row"><label>Popis pozice</label><select id="pozice_popis"></select></div>

  <div class="row"><button id="genDocx" disabled>Generovat DOCX</button></div>
  <p id="status"></p>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // worker pro pdf.js
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';

      const $ = id=>document.getElementById(id);
      const statusEl = $('status');
      const msg = (t,err=false)=>{ statusEl.textContent=t; statusEl.style.color=err?'#b00':'#006400'; };

      // data pro dropdowny
      const FACTOR=[/* sem celý seznam 23 faktorů */];
      const CAT=["","Kat. 1","Kat. 2","Kat. 3","Kat. 4"];
      const BRANCH_LIST=[/* sem 22 poboček */];
      const CONSULT_LIST=[/* sem 9 konzultantů */];
      const POS_DESC={/* sem popisy pozic klíč→text */};

      function fill(sel,arr){
        sel.innerHTML='';
        arr.forEach(v=>sel.add(new Option(v,v)));
      }
      fill($('pobocka'),BRANCH_LIST);
      fill($('konzultant'),CONSULT_LIST);
      fill($('pozice_popis'),Object.keys(POS_DESC));

      for(let i=1;i<=6;i++){
        const r=document.createElement('div'); r.className='row';
        const sf=document.createElement('select'), sk=document.createElement('select');
        sf.id='faktor'+i; sk.id='kategorie'+i;
        fill(sf,FACTOR); fill(sk,CAT);
        if(i===1){ sf.value='Vyšetření v základním rozsahu'; sk.value='Kat. 1'; }
        r.append(sf,sk);
        $('factors').append(r);
      }

      // drag & drop
      const dz=$('dropZone'), fi=$('fileInput');
      dz.addEventListener('click',()=>fi.click());
      ['dragenter','dragover'].forEach(ev=>
        dz.addEventListener(ev,e=>{ e.preventDefault(); dz.classList.add('drag'); })
      );
      ['dragleave','drop'].forEach(ev=>
        dz.addEventListener(ev,()=>dz.classList.remove('drag'))
      );
      dz.addEventListener('drop',e=>{
        e.preventDefault();
        if(e.dataTransfer.files[0]) handlePDF(e.dataTransfer.files[0]);
      });
      fi.addEventListener('change',e=>{
        if(e.target.files[0]) handlePDF(e.target.files[0]);
      });

      // parsování PDF
      async function handlePDF(file){
        msg('Čtu PDF…');
        $('genDocx').disabled=true;
        try{
          const data=new Uint8Array(await file.arrayBuffer());
          const pdf=await pdfjsLib.getDocument({data}).promise;
          const page=await pdf.getPage(1);
          const ann=await page.getAnnotations({intent:'display'});
          const get=name=>ann.find(a=>a.fieldName?.trim()===name)?.fieldValue||'';
          $('jmeno').value=get('jmeno');
          $('narozeni').value=(get('narozeni')||'').split('/')[0].trim();
          $('adresa').value=[get('trvale-bydliste-ulice'),get('trvale-bydliste-mesto')].filter(Boolean).join(', ');
          $('psc').value=get('trvale-bydliste-psc');
          msg('PDF načteno');
          $('genDocx').disabled=false;
        }catch(e){
          console.error(e);
          msg('Chyba při čtení PDF',true);
        }
      }

      // načíst šablonu
      let tplBuf=null;
      fetch(`LP_template.docx?cb=${Date.now()}`)
        .then(r=>r.ok?r.arrayBuffer():Promise.reject())
        .then(b=>{ tplBuf=b; msg('Šablona načtena'); })
        .catch(()=>msg('Šablonu nelze načíst',true));

      // generování pomocí Docxtemplater
      $('genDocx').addEventListener('click',()=>{
        if(!tplBuf){ alert('Nejdřív načti šablonu'); return; }
        msg('Generuji…');

        const zip=new PizZip(tplBuf);
        const doc=new window.Docxtemplater().loadZip(zip);
        const ctx={
          jmeno:$('jmeno').value,
          narozeni:$('narozeni').value,
          adresa:$('adresa').value,
          psc:$('psc').value,
          pobocka:$('pobocka').value,
          pozice:$('pozice').value,
          konzultant:$('konzultant').value,
          pozice_popis:$('pozice_popis').value,
          popis_pozice:POS_DESC[$('pozice_popis').value]||'',
          datum:new Date().toLocaleDateString('cs-CZ')
        };
        // přidej faktory
        for(let i=1;i<=6;i++){
          ctx['faktor'+i]    = $('faktor'+i).value;
          ctx['kategorie'+i] = $('kategorie'+i).value;
        }

        doc.setData(ctx);
        try {
          doc.render();
        } catch(error) {
          console.error(error);
          msg('Chyba při renderu šablony',true);
          return;
        }

        const out=doc.getZip().generate({
          type:'blob',
          mimeType:'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
        });
        saveAs(out, `LP_${(ctx.jmeno.split(' ').pop()||'posudek')}.docx`);
        msg('Hotovo – soubor stažen');
      });
    });
  </script>
</body>
</html>
