<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <title>AURES Generátor LP – Debug</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f5f5f5;margin:0;padding:20px;color:#222}
    h1{font-size:26px;margin-bottom:10px}
    h3{margin-top:30px}
    .row{display:flex;gap:12px;margin-bottom:12px;align-items:center}
    label{width:140px;font-weight:600}
    input,select{flex:1;min-width:200px;padding:6px;border:1px solid #ccc;border-radius:4px}
    button{padding:10px 18px;background:#007ACC;color:#fff;border:none;border-radius:4px;cursor:pointer}
    button:disabled{background:#ccc;cursor:not-allowed}
    #dropZone{border:2px dashed #888;padding:20px;text-align:center;margin:20px 0;border-radius:6px;background:#fff;cursor:pointer}
    #dropZone.drag{border-color:#007ACC;background:#eef6ff}
    #status{margin-top:14px;font-size:14px;min-height:18px}
    #debug{white-space:pre-wrap;background:#fff;border:1px solid #ccc;padding:10px;margin-top:10px;font-family:monospace;font-size:14px;max-height:200px;overflow:auto}
  </style>
  <script defer src="https://cdn.jsdelivr.net/npm/pizzip@3.1.1/dist/pizzip.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
</head>
<body>
  <h1>AURES Generátor LP – Debug</h1>

  <div id="dropZone">
    Přetáhni PDF sem nebo klikni
    <input type="file" id="fileInput" accept="application/pdf" hidden>
  </div>

  <div class="row"><label>Jméno</label><input id="jmeno"></div>
  <div class="row"><label>Datum narození</label><input id="narozeni"></div>
  <div class="row"><label>Adresa</label><input id="adresa"></div>
  <div class="row"><label>PSČ</label><input id="psc"></div>

  <h3>Faktory a kategorie</h3>
  <div id="factors"></div>

  <div class="row"><label>Pobočka</label><select id="pobocka"></select></div>
  <div class="row"><label>Pozice</label><input id="pozice" value="Prodejce"></div>
  <div class="row"><label>Konzultant</label><select id="konzultant"></select></div>
  <div class="row"><label>Popis pozice</label><select id="pozice_popis"></select></div>

  <div class="row"><button id="genDocx" disabled>Generovat DOCX</button></div>
  <p id="status"></p>
  <pre id="debug">Debug výstup placeholderů...</pre>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';

    const $ = id => document.getElementById(id);
    const msg = (t, err=false) => {
      $('status').textContent = t;
      $('status').style.color = err ? '#b00' : '#006400';
    };

    // data
    const FACTOR = [
      "Zátěž chladem","Fyzická zátěž","Pracovní poloha","Hluk","Vibrace","Prach",
      "Chemické látky a směsi","------------------","Biologické činitele",
      "Činnosti epidemiologicky závažné","Elektrotechnik dle vyhl č.50 / 1978 Sb.",
      "Neionizující záření","Obsluha tlakových nádob a zařízení vys. napětí",
      "Obsluha transport. a vysokozdvižných vozíků","Obsluha transport. vytáhů a jeřábů a vázaní břemen",
      "Práce v noci","Práce ve výškách a nad volnou hloubkou","Psychická zátěž",
      "Řidič do 7,5 tuny","Řidič nad 7,5 tuny","Vyšetření v základním rozsahu",
      "Zátěž teplem","Zraková zátěž"
    ];
    const CAT = ["","Kat. 1","Kat. 2","Kat. 3","Kat. 4"];
    const BRANCH_LIST = [
      "Brno","Chomutov","České Budějovice","Čestlice","Hradec Králové","Jihlava",
      "Kladno","Kolín","Liberec","Mladá Boleslav","Olomouc","Opava","Ostrava",
      "Pardubice","Plzeň","Praha","Sokolov","Tábor","Teplice","Ústí nad Labem",
      "Valašské Mezičíčí","Zlín","Znojmo"
    ];
    const CONSULT_LIST = [
      "Anna Brůčková","Anna Kučerová","Alžběta Čermáková","Blanka Poliaková",
      "Jan Jarma","Kamila Hušková","Karolína Kulvaitová","Miroslava Válková",
      "Ondřej Dolejš"
    ];
    const POS_DESC = {
      "Call Centrum":"Činnost s klienty po telefonu, práce na PC, administrativa. Dvousměnný provoz.",
      "Manažer/Zástupce manažera":"Vedení týmu, administrativa, řízení služebního auta.",
      "Prodejce":"Jednání s klienty, PC, řízení auta, částečně venku.",
      "Nákupčí / Testovací technik":"Administrativa + testování vozů, řízení auta.",
      "Výpomoc při přípravě vozů k prodeji":"Mytí a čištění vozů venku. Bez řízení auta.",
      "Mechanik":"Údržba a opravy vozidel, chemikálie H314. Řízení auta.",
      "Uklízečka":"Úklid areálu.","Stock kontrolor":"Kontrola vozového parku, převoz vozů v areálu.",
      "Řidič do 7,5t/ Kurýr":"Přeprava zákazníků a vozidel.","Řidič nad 7,5t":"Přeprava vozů mezi pobočkami"
    };

    function fill(sel, arr) {
      sel.innerHTML = '';
      arr.forEach(v => sel.add(new Option(v, v)));
    }
    fill($('pobocka'), BRANCH_LIST);
    fill($('konzultant'), CONSULT_LIST);
    fill($('pozice_popis'), Object.keys(POS_DESC));

    // faktory
    for (let i = 1; i <= 6; i++) {
      const r = document.createElement('div');
      r.className = 'row';
      const f = document.createElement('select');
      const k = document.createElement('select');
      f.id = 'faktor'+i; k.id = 'kategorie'+i;
      fill(f, FACTOR); fill(k, CAT);
      if (i===1) { f.value='Vyšetření v základním rozsahu'; k.value='Kat. 1'; }
      r.append(f, k);
      $('factors').append(r);
    }

    // drag/drop
    const dz = $('dropZone'), fi = $('fileInput');
    dz.addEventListener('click', ()=>fi.click());
    ['dragenter','dragover'].forEach(ev=>
      dz.addEventListener(ev, e=>{ e.preventDefault(); dz.classList.add('drag'); })
    );
    ['dragleave','drop'].forEach(ev=>
      dz.addEventListener(ev, ()=>dz.classList.remove('drag'))
    );
    dz.addEventListener('drop', e=>{ e.preventDefault(); if(e.dataTransfer.files[0]) handlePDF(e.dataTransfer.files[0]); });
    fi.addEventListener('change', e=>{ if(e.target.files[0]) handlePDF(e.target.files[0]); });

    // čtení PDF
    async function handlePDF(file) {
      msg('Čtu PDF…');
      $('genDocx').disabled = true;
      try {
        const data = new Uint8Array(await file.arrayBuffer());
        const pdf = await pdfjsLib.getDocument({data}).promise;
        const page = await pdf.getPage(1);
        const ann  = await page.getAnnotations({intent:'display'});
        const get  = name=>ann.find(a=>a.fieldName?.trim()===name)?.fieldValue||'';
        $('jmeno').value    = get('jmeno');
        $('narozeni').value = (get('narozeni')||'').split('/')[0].trim();
        $('adresa').value   = [get('trvale-bydliste-ulice'),get('trvale-bydliste-mesto')].filter(Boolean).join(', ');
        $('psc').value      = get('trvale-bydliste-psc');
        msg('PDF načteno');
        $('genDocx').disabled = false;
      } catch(e) {
        console.error(e);
        msg('Chyba při čtení PDF', true);
      }
    }

    // načtení šablony
    let tplBuf = null;
    fetch(`LP_template.docx?cb=${Date.now()}`)
      .then(r=>r.ok?r.arrayBuffer():Promise.reject())
      .then(b=>{ tplBuf = b; msg('Šablona načtena'); })
      .catch(()=>msg('Šablonu nelze načíst', true));

    // generování
    $('genDocx').addEventListener('click', () => {
      if (!tplBuf) { alert('Nejdřív načti šablonu'); return; }
      msg('Generuji…');

      const zip = new PizZip(new Uint8Array(tplBuf));
      let xml = zip.file('word/document.xml').asText();

      // debug: vypsat všechny placeholdery
      const raw = xml.match(/\{\{\s*[^}]+\s*\}\}/g) || [];
      $('debug').textContent = 'Placeholdery v XML:\n' + raw.join('\n');

      // spoj runů a textů
      xml = xml.replace(/<\/w:r>\s*<w:r[^>]*>/g, '');
      xml = xml.replace(/<\/w:t>\s*<w:t[^>]*>/g, '');

      // data pro nahrazení
      const ctx = {
        jmeno:$('jmeno').value,
        narozeni:$('narozeni').value,
        adresa:$('adresa').value,
        psc:$('psc').value,
        pobocka:$('pobocka').value,
        pozice:$('pozice').value,
        konzultant:$('konzultant').value,
        pozice_popis:$('pozice_popis').value,
        popis_pozice:POS_DESC[$('pozice_popis').value]||'',
        datum:new Date().toLocaleDateString('cs-CZ')
      };
      for (let i=1;i<=6;i++){
        ctx['faktor'+i]    = $('faktor'+i).value;
        ctx['kategorie'+i] = $('kategorie'+i).value;
      }

      // nahrazení
      Object.entries(ctx).forEach(([k,v])=>{
        xml = xml.replace(new RegExp(`\\{\\{\\s*${k}\\s*\\}\\}`,'g'), v);
      });

      zip.file('word/document.xml', xml);
      const blob = zip.generate({ type:'blob',
        mimeType:'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
      });
      saveAs(blob, `LP_${(ctx.jmeno.split(' ').pop()||'posudek')}.docx`);
      msg('Hotovo – soubor stažen');
    });
  });
  </script>
</body>
</html>