<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8">
<title>AURES Generátor LP</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f5f5f5;margin:0;padding:20px;color:#222}
  h1{font-size:26px;margin-bottom:20px}
  .row{display:flex;gap:12px;margin-bottom:12px;align-items:center;flex-wrap:wrap}
  label{width:140px;font-weight:600}
  input,select{flex:1;min-width:200px;padding:6px;border:1px solid #ccc;border-radius:4px}
  button{padding:10px 18px;background:#007ACC;color:#fff;border:none;border-radius:4px;cursor:pointer}
  button:disabled{background:#ccc;cursor:not-allowed}
  #dropZone{border:2px dashed #888;padding:20px;text-align:center;margin:20px 0;border-radius:6px;background:#fff;cursor:pointer}
  #dropZone.drag{border-color:#007ACC;background:#eef6ff}
  #status{margin-top:14px;font-size:14px;min-height:18px}
</style>

<!-- knihovny -->
<script defer src="https://cdn.jsdelivr.net/npm/pizzip@3.1.1/dist/pizzip.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/docxtemplater@3.27.0/build/docxtemplater.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
</head>
<body>
<h1>AURES Generátor LP</h1>

<div id="dropZone">
  Přetáhni PDF sem nebo klikni
  <input type="file" id="fileInput" accept="application/pdf" hidden>
</div>

<div class="row"><label>Jméno</label><input id="jmeno"></div>
<div class="row"><label>Datum narození</label><input id="narozeni" placeholder="DD.MM.RRRR"></div>
<div class="row"><label>Adresa</label><input id="adresa"></div>
<div class="row"><label>PSČ</label><input id="psc"></div>

<h3>Faktory a kategorie (1–6)</h3>
<div id="factors"></div>

<div class="row"><label>Pobočka</label><select id="pobocka"></select></div>
<div class="row"><label>Pozice</label><input id="pozice" value="Prodejce"></div>
<div class="row"><label>Konzultant</label><select id="konzultant"></select></div>
<div class="row"><label>Popis pozice</label><select id="pozice_popis"></select></div>

<div class="row"><button id="genDocx" disabled>Generovat DOCX</button></div>
<p id="status"></p>

<script>
/* ------------ util ------------ */
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
const $=id=>document.getElementById(id);
const msg=(t,e=false)=>{$('status').textContent=t;$('status').style.color=e?'#b00':'#006400';};

/* ------------ číselníky (zkrácené) ------------ */
const FACTOR=['Vyšetření v základním rozsahu',/*…*/], CAT=['','Kat. 1','Kat. 2','Kat. 3','Kat. 4'];
const BRANCH=['Brno','Praha',/*…*/], CONSULT=['Anna Brůčková','Ondřej Dolejš',/*…*/];
const POS_DESC={'Prodejce':'Jednání s klienty …',/*…*/};

/* selecty */
const fill=(s,a)=>{s.innerHTML='';a.forEach(v=>s.add(new Option(v,v)));};
fill($('pobocka'),BRANCH);fill($('konzultant'),CONSULT);fill($('pozice_popis'),Object.keys(POS_DESC));
for(let i=1;i<=6;i++){const r=document.createElement('div');r.className='row';
  const sf=document.createElement('select');sf.id='faktor'+i;fill(sf,FACTOR);
  const sk=document.createElement('select');sk.id='kategorie'+i;fill(sk,CAT);
  if(i===1){sf.value='Vyšetření v základním rozsahu';sk.value='Kat. 1';}
  r.append(sf,sk);$('factors').append(r);}

/* drag & drop */
const dz=$('dropZone'),fi=$('fileInput');
dz.onclick=()=>fi.click();['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.classList.add('drag');}));
['dragleave','drop'].forEach(ev=>dz.addEventListener(ev,()=>dz.classList.remove('drag')));
dz.addEventListener('drop',e=>{e.preventDefault();if(e.dataTransfer.files[0])loadPDF(e.dataTransfer.files[0]);});
fi.addEventListener('change',e=>{if(e.target.files[0])loadPDF(e.target.files[0]);});

/* PDF načtení */
async function loadPDF(f){msg('Čtu PDF…');$('genDocx').disabled=true;
  try{const buf=new Uint8Array(await f.arrayBuffer());
    const pdf=await pdfjsLib.getDocument({data:buf}).promise;
    const ann=await (await pdf.getPage(1)).getAnnotations({intent:'display'});
    const get=n=>ann.find(a=>a.fieldName?.trim()===n)?.fieldValue||'';
    $('jmeno').value=get('jmeno');$('narozeni').value=(get('narozeni')||'').split('/')[0].trim();
    $('adresa').value=[get('trvale-bydliste-ulice'),get('trvale-bydliste-mesto')].filter(Boolean).join(', ');
    $('psc').value=get('trvale-bydliste-psc');$('pozice').value=get('pozice')||$('pozice').value;
    msg('PDF načteno');$('genDocx').disabled=false;}
  catch(e){console.error(e);msg('Chyba při čtení PDF',true);}}

/* šablona */
let tpl=null;
fetch('LP_template.docx').then(r=>r.ok?r.arrayBuffer():Promise.reject())
  .then(b=>{tpl=b;msg('Šablona načtena');}).catch(()=>msg('Šablonu nelze načíst',true));

/* generování */
$('genDocx').addEventListener('click',()=>{
  if(!tpl){alert('Šablona chybí');return;} msg('Generuji…');
  try{
    const zip=new PizZip(tpl);
    const DocxCtor=window.Docxtemplater||window.DocxTemplater;
    const doc=new DocxCtor().loadZip(zip);

    const d={jmeno:$('jmeno').value.trim(),narozeni:$('narozeni').value.trim(),adresa:$('adresa').value.trim(),
      psc:$('psc').value.trim(),pobocka:$('pobocka').value.trim(),pozice:$('pozice').value.trim(),
      konzultant:$('konzultant').value.trim(),pozice_popis:$('pozice_popis').value.trim(),
      popis_pozice:POS_DESC[$('pozice_popis').value.trim()]||'',datum:new Date().toLocaleDateString('cs-CZ')};
    for(let i=1;i<=6;i++){d['faktor'+i]=$('faktor'+i).value;d['kategorie'+i]=$('kategorie'+i).value;}

    doc.setData(d); doc.render();
    const out=doc.getZip().generate({type:'blob',
      mimeType:'application/vnd.openxmlformats-officedocument.wordprocessingml.document'});
    saveAs(out,'LP_'+d.jmeno.replace(/\\s+/g,'_')+'.docx');
    msg('Hotovo – soubor stažen');}
  catch(err){console.error(err);msg('Chyba generování',true);} });
</script>
</body>
</html>
